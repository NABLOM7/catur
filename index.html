<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Catur Web Custom Bidak</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 18px;}
    h2 { margin-bottom: 12px; }
    #welcome, #chooseMode, #inputNames, #game, #result { margin-top: 15px; }
    #board { margin: 12px auto; }
    button, input, select { font-size: 16px; padding: 8px 14px; border-radius: 5px; border: 1px solid #888; }
    button { cursor: pointer; background-color: #eaeaea; }
    button:hover { background-color: #cfcfcf; }
    input { width: 200px; }
    .hidden { display: none; }
    #status { margin-top: 12px; font-weight: bold; }
    #footer { margin-top: 40px; font-size: 12px; color: #777; }
    /* Highlight bidak yang dipilih */
    .square.selected { box-shadow: 0 0 0 4px #2a7b1f, 0 0 15px #2a7b1f8c; z-index: 2; }
    /* Marker langkah legal */
    .square.move-marker { position: relative; }
    .square.move-marker::after {
      content: "";
      position: absolute;
      left: 50%; top: 50%;
      width: 18px; height: 18px;
      background: rgba(36,150,38,0.85);
      border-radius: 50%;
      transform: translate(-50%,-50%);
      z-index: 3;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h2>catur web</h2>
  <div id="welcome"><p>Selamat datang di catur web</p></div>
  <!-- Pilih Mode & Nama (disederhanakan, bisa disesuaikan) -->
  <div id="chooseMode">
    <button id="modeBot">Player vs Bot</button>
    <button id="modeP2">Player vs Player</button>
  </div>
  <div id="inputNames" class="hidden">
    <div id="inputBot" class="hidden">
      <input type="text" id="playerBotName" placeholder="Nama Anda" />
      <label>Pilih warna:</label>
      <select id="colorSelectBot">
        <option value="w">Putih</option>
        <option value="b">Hitam</option>
      </select>
      <button id="botNext">Mulai</button>
    </div>
    <div id="inputPvP" class="hidden">
      <input type="text" id="player1Name" placeholder="Nama Pemain 1 (Putih)" /><br><br>
      <input type="text" id="player2Name" placeholder="Nama Pemain 2 (Hitam)" /><br><br>
      <button id="pvpNext">Mulai</button>
    </div>
  </div>
  <!-- Game -->
  <div id="game" class="hidden">
    <div id="board" style="width: 320px;"></div>
    <div id="status"></div>
    <button id="restartBtn">Ulang</button>
  </div>
  <!-- Result -->
  <div id="result" class="hidden">
    <p id="resultText"></p>
  </div>
  <div id="footer">&copy; catur simple by NABLOM</div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    let game = new Chess();
    let board = null;
    let gameMode = "";
    let playerColor = "w";
    let player1Name = "", player2Name = "", playerBotName = "";
    let startTime = null;
    let selectedSquare = null;   // square bidak yang dipilih, misal "g1"
    let moveSquares = [];        // array square tujuan legal, misal ["f3","h3"]

    // --- PILIH MODE & NAMA ---
    $("#modeBot").click(function() {
      gameMode = "bot";
      $("#chooseMode").hide();
      $("#inputNames").show(); $("#inputBot").show();
    });
    $("#modeP2").click(function() {
      gameMode = "pvp";
      $("#chooseMode").hide();
      $("#inputNames").show(); $("#inputPvP").show();
    });
    $("#botNext").click(function() {
      playerBotName = $("#playerBotName").val().trim();
      playerColor = $("#colorSelectBot").val();
      if (!playerBotName) { alert("Nama wajib diisi."); return; }
      $("#inputBot").hide(); $("#inputNames").hide(); startGame();
    });
    $("#pvpNext").click(function() {
      player1Name = $("#player1Name").val().trim();
      player2Name = $("#player2Name").val().trim();
      if (!player1Name || !player2Name) { alert("Nama semua pemain wajib diisi."); return; }
      $("#inputPvP").hide(); $("#inputNames").hide();
      playerColor = "w"; startGame();
    });

    // --- GAME UTAMA ---
    function startGame() {
      game.reset(); startTime = new Date();
      $("#result").hide(); $("#game").show();
      selectedSquare = null; moveSquares = [];
      if (board) board.destroy();
      board = Chessboard("board", {
        draggable: false,
        position: "start",
        pieceTheme: "img/{piece}.png",
        orientation: (gameMode === "bot" ? (playerColor === "w" ? "white" : "black") : "white"),
        // Disable drag & drop
        onPieceClick: onPieceClick,   // custom handler
        onSquareClick: onSquareClick, // custom handler
      });
      if (gameMode === "bot" && playerColor === "b") setTimeout(botMove, 400);
      renderBoardMarkers();
      updateStatus();
    }

    // --- CUSTOM INTERAKSI: PILIH BIDAK DULU ---
    $("#board").on("click", ".square", function() {
      let square = $(this).data("square");
      if (!square) return;
      if (selectedSquare) {
        // Jika klik ke salah satu kotak tujuan legal -> jalankan move
        if (moveSquares.includes(square)) {
          doMove(selectedSquare, square);
          selectedSquare = null; moveSquares = [];
          renderBoardMarkers();
          return;
        }
      }
      // Jika klik bidak sendiri: highlight & tampilkan marker langkah legal
      let piece = game.get(square);
      if (piece && piece.color === game.turn()) {
        selectedSquare = square;
        moveSquares = getLegalMoves(square).map(m => m.to);
        renderBoardMarkers();
      }
    });

    function onPieceClick(piece, square) { /* Not used, logic di atas */ }
    function onSquareClick(square)        { /* Not used, logic di atas */ }

    function getLegalMoves(square) {
      // chess.js: ambil langkah legal dari square
      return game.moves({ square: square, verbose: true });
    }
    function doMove(from, to) {
      // Cek promosi pawn
      let piece = game.get(from);
      let promotion = undefined;
      if (piece && piece.type === "p" &&
          ((piece.color === "w" && from[1] === "7" && to[1] === "8") ||
           (piece.color === "b" && from[1] === "2" && to[1] === "1"))) {
        promotion = prompt("Promosi ke (q,r,b,n):", "q") || "q";
      }
      let moveObj = { from: from, to: to };
      if (promotion) moveObj.promotion = promotion;
      let move = game.move(moveObj);
      if (move === null) return; // illegal
      board.position(game.fen());
      renderBoardMarkers();
      updateStatus();
      // Bot jalan jika perlu
      if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) setTimeout(botMove, 450);
      if (game.game_over()) endGame();
    }

    function renderBoardMarkers() {
      // Hilangkan semua marker & highlight
      $("#board .square").removeClass("selected move-marker");
      // Highlight bidak yang dipilih
      if (selectedSquare) {
        $(`#board .square[data-square='${selectedSquare}']`).addClass("selected");
        // Marker langkah legal
        moveSquares.forEach(sq => {
          $(`#board .square[data-square='${sq}']`).addClass("move-marker");
        });
      }
    }

    function botMove() {
      let moves = game.moves({ verbose: true });
      if (!moves.length) return;
      // Pilih random move, prioritaskan promosi queen jika ada
      let promoMoves = moves.filter(m => m.flags.includes("p"));
      let move = promoMoves.length ? promoMoves.find(m => m.promotion === "q") || promoMoves[0] : moves[Math.floor(Math.random()*moves.length)];
      game.move({ from: move.from, to: move.to, promotion: move.promotion });
      board.position(game.fen());
      renderBoardMarkers();
      updateStatus();
      if (game.game_over()) endGame();
    }

    function updateStatus() {
      let status = "";
      // Skak
      if (game.in_check()) {
        status = (game.turn() === "w" ? "Raja Putih Skak!" : "Raja Hitam Skak!") + " ";
      }
      // Selesai
      if (game.in_checkmate()) {
        status += "Checkmate! " + (game.turn() === "w" ? "Hitam" : "Putih") + " menang!";
      } else if (game.in_draw()) {
        status += "Seri.";
      } else {
        status += (game.turn() === "w" ? "Giliran Putih" : "Giliran Hitam");
        if (gameMode === "pvp") {
          status += ". ";
          status += (game.turn() === "w" ? player1Name : player2Name) + " jalan";
        }
        if (gameMode === "bot") {
          status += ". ";
          status += (game.turn() === playerColor ? playerBotName : "Bot") + " jalan";
        }
      }
      $("#status").text(status);
    }

    function endGame() {
      const endTime = new Date();
      const duration = ((endTime - startTime) / 1000).toFixed(2);
      let message = "";
      if (game.in_checkmate()) {
        const winner = game.turn() === "w" ? "Hitam" : "Putih";
        if (gameMode === "bot") {
          message = `Game selesai, pemenang: ${winner}. Nama: ${playerBotName}, durasi: ${duration} detik.`;
        } else {
          let pemenangNama = (winner === "Putih") ? player1Name : player2Name;
          message = `Game selesai, pemenang: ${winner} (${pemenangNama}). P1: ${player1Name}, P2: ${player2Name}, durasi: ${duration} detik.`;
        }
      } else {
        message = `Game selesai seri. Durasi: ${duration} detik.`;
      }
      $("#resultText").text(message);
      $("#result").show();
    }
    $("#restartBtn").click(function() {
      $("#game").hide(); $("#result").hide(); $("#chooseMode").show();
      player1Name = ""; player2Name = ""; playerBotName = "";
      $("#player1Name").val(""); $("#player2Name").val(""); $("#playerBotName").val("");
      $("#inputBot").hide(); $("#inputPvP").hide();
    });
    $(document).ready(function() {
      $("#inputBot").hide(); $("#inputPvP").hide();
    });
  </script>
</body>
</html>
