<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catur Web Klik Mode</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 18px;}
    h2 { margin-bottom: 12px; }
    #chooseMode, #inputNames, #game, #result { margin-top: 15px; }
    #board { margin: 14px auto; }
    button, input, select { font-size: 16px; padding: 7px 12px; border-radius: 5px; border: 1px solid #888; }
    .hidden { display: none; }
    #status { margin: 12px auto 12px auto; font-weight: bold; min-height:32px;}
    #footer { margin-top: 40px; font-size: 12px; color: #777; }
    .square.selected { box-shadow: 0 0 0 4px #2a7b1f, 0 0 15px #2a7b1f8c; z-index: 2; }
    .square.move-marker { position: relative; }
    .square.move-marker::after {
      content: "";
      position: absolute;
      left: 50%; top: 50%;
      width: 18px; height: 18px;
      background: rgba(36,150,38,0.85);
      border-radius: 50%;
      transform: translate(-50%,-50%);
      z-index: 3;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h2>Catur Web Mode</h2>
  <!-- Pilih Mode -->
  <div id="chooseMode">
    <button id="modeBot">Player vs Bot</button>
    <button id="modeP2">Player vs Player</button>
  </div>
  <!-- Input Nama -->
  <div id="inputNames" class="hidden">
    <div id="inputBot" class="hidden">
      <input type="text" id="playerBotName" placeholder="Nama Anda" />
      <label>Pilih warna:</label>
      <select id="colorSelectBot">
        <option value="w">Putih</option>
        <option value="b">Hitam</option>
      </select>
      <button id="botNext">Mulai</button>
    </div>
    <div id="inputPvP" class="hidden">
      <input type="text" id="player1Name" placeholder="Nama Pemain 1 (Putih)" /><br><br>
      <input type="text" id="player2Name" placeholder="Nama Pemain 2 (Hitam)" /><br><br>
      <button id="pvpNext">Mulai</button>
    </div>
  </div>
  <div id="game" class="hidden">
    <div id="status"></div>
    <div id="board" style="width: 320px;"></div>
    <button id="restartBtn">Ulang Permainan</button>
  </div>
  <div id="result" class="hidden">
    <p id="resultText"></p>
  </div>
  <div id="footer">&copy; catur klik NABLOM7</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    let game = new Chess();
    let board = null;
    let selectedSquare = null;   // square bidak yang dipilih, misal "g1"
    let moveSquares = [];        // array square tujuan legal, misal ["f3","h3"]
    let gameMode = "";
    let playerColor = "w";
    let player1Name = "", player2Name = "", playerBotName = "";
    let startTime = null;

    // Pilih mode game
    $("#modeBot").click(function() {
      gameMode = "bot";
      $("#chooseMode").hide();
      $("#inputNames").show(); $("#inputBot").show();
    });
    $("#modeP2").click(function() {
      gameMode = "pvp";
      $("#chooseMode").hide();
      $("#inputNames").show(); $("#inputPvP").show();
    });
    $("#botNext").click(function() {
      playerBotName = $("#playerBotName").val().trim();
      playerColor = $("#colorSelectBot").val();
      if (!playerBotName) { alert("Nama wajib diisi."); return; }
      $("#inputBot").hide(); $("#inputNames").hide(); startGame();
    });
    $("#pvpNext").click(function() {
      player1Name = $("#player1Name").val().trim();
      player2Name = $("#player2Name").val().trim();
      if (!player1Name || !player2Name) { alert("Nama semua pemain wajib diisi."); return; }
      $("#inputPvP").hide(); $("#inputNames").hide();
      playerColor = "w"; startGame();
    });

    // Inisialisasi papan catur
    function startGame() {
      game.reset();
      selectedSquare = null; moveSquares = [];
      $("#result").hide(); $("#game").show();
      if (board) board.destroy();
      board = Chessboard("board", {
        draggable: false,
        position: "start",
        pieceTheme: "img/{piece}.png",
        orientation: (gameMode === "bot" ? (playerColor === "w" ? "white" : "black") : "white")
      });
      setTimeout(renderBoardMarkers, 120);
      updateStatus();
      if (gameMode === "bot" && playerColor === "b") setTimeout(botMove, 400);
    }

    // Interaksi klik
    $("#board").on("click", ".square", function() {
      const square = $(this).attr("data-square");
      if (!square) return;
      // Jika sudah memilih bidak: klik kotak marker untuk move
      if (selectedSquare && moveSquares.includes(square)) {
        doMove(selectedSquare, square);
        selectedSquare = null; moveSquares = [];
        renderBoardMarkers();
        return;
      }
      // Pilih bidak sendiri
      const piece = game.get(square);
      if (piece && piece.color === game.turn()) {
        selectedSquare = square;
        moveSquares = game.moves({ square: square, verbose: true }).map(m => m.to);
        renderBoardMarkers();
      }
    });

    function doMove(from, to) {
      const piece = game.get(from);
      let promotion = undefined;
      if (piece && piece.type === "p" &&
          ((piece.color === "w" && from[1] === "7" && to[1] === "8") ||
           (piece.color === "b" && from[1] === "2" && to[1] === "1"))) {
        promotion = prompt("Promosi ke (q,r,b,n):", "q") || "q";
      }
      let moveObj = { from: from, to: to };
      if (promotion) moveObj.promotion = promotion;
      let move = game.move(moveObj);
      if (move === null) return;
      board.position(game.fen());
      renderBoardMarkers();
      updateStatus();
      if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) setTimeout(botMove, 450);
      if (game.game_over()) endGame();
    }

    function renderBoardMarkers() {
      $(".square").removeClass("selected move-marker");
      if (selectedSquare) {
        $(`[data-square='${selectedSquare}']`).addClass("selected");
        moveSquares.forEach(sq => $(`[data-square='${sq}']`).addClass("move-marker"));
      }
    }

    function botMove() {
      let moves = game.moves({ verbose: true });
      if (!moves.length) return;
      let promoMoves = moves.filter(m => m.flags.includes("p"));
      let move = promoMoves.length ? promoMoves.find(m => m.promotion === "q") || promoMoves[0] : moves[Math.floor(Math.random()*moves.length)];
      game.move({ from: move.from, to: move.to, promotion: move.promotion });
      board.position(game.fen());
      renderBoardMarkers();
      updateStatus();
      if (game.game_over()) endGame();
    }

    function updateStatus() {
      let status = "";
      if (game.in_check()) {
        status += (game.turn() === "w" ? "Raja Putih Skak! " : "Raja Hitam Skak! ");
      }
      if (game.in_checkmate()) {
        status += "Checkmate! " + (game.turn() === "w" ? "Hitam" : "Putih") + " menang!";
      } else if (game.in_draw()) {
        status += "Seri.";
      } else {
        status += (game.turn() === "w" ? "Giliran Putih" : "Giliran Hitam");
        if (gameMode === "pvp") {
          status += ". ";
          status += (game.turn() === "w" ? player1Name : player2Name) + " jalan";
        }
        if (gameMode === "bot") {
          status += ". ";
          status += (game.turn() === playerColor ? playerBotName : "Bot") + " jalan";
        }
      }
      $("#status").text(status);
    }

    function endGame() {
      let status = $("#status").text();
      $("#resultText").text(status);
      $("#result").show();
    }

    $("#restartBtn").click(function() {
      $("#game").hide(); $("#result").hide(); $("#chooseMode").show();
      player1Name = ""; player2Name = ""; playerBotName = "";
      $("#player1Name").val(""); $("#player2Name").val(""); $("#playerBotName").val("");
      $("#inputBot").hide(); $("#inputPvP").hide();
    });

    $(document).ready(function(){
      $("#inputBot").hide(); $("#inputPvP").hide();
    });
  </script>
</body>
</html>
