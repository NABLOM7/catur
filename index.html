<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Catur Web Custom Bidak</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 18px;}
    h2 { margin-bottom: 12px; }
    #welcome, #chooseMode, #chooseColor, #inputNames, #game, #result { margin-top: 15px; }
    #board { margin: 12px auto; }
    button, input, select { font-size: 16px; padding: 8px 14px; border-radius: 5px; border: 1px solid #888; }
    button { cursor: pointer; background-color: #eaeaea; }
    button:hover { background-color: #cfcfcf; }
    input { width: 200px; }
    .hidden { display: none; }
    #status { margin-top: 12px; font-weight: bold; }
    #footer { margin-top: 40px; font-size: 12px; color: #777; }
  </style>
</head>
<body>
  <h2>catur web</h2>
  <div id="welcome"><p>Selamat datang di catur web</p></div>

  <!-- Pilih Mode -->
  <div id="chooseMode">
    <button id="modeBot">Player vs Bot</button>
    <button id="modeP2">Player vs Player</button>
  </div>

  <!-- Input Nama -->
  <div id="inputNames" class="hidden">
    <div id="inputBot" class="hidden">
      <input type="text" id="playerBotName" placeholder="Nama Anda" />
      <label>Pilih warna:</label>
      <select id="colorSelectBot">
        <option value="w">Putih</option>
        <option value="b">Hitam</option>
      </select>
      <button id="botNext">Mulai</button>
    </div>
    <div id="inputPvP" class="hidden">
      <input type="text" id="player1Name" placeholder="Nama Pemain 1 (Putih)" /><br><br>
      <input type="text" id="player2Name" placeholder="Nama Pemain 2 (Hitam)" /><br><br>
      <button id="pvpNext">Mulai</button>
    </div>
  </div>

  <!-- Game -->
  <div id="game" class="hidden">
    <div id="board" style="width: 320px;"></div>
    <div id="status"></div>
    <button id="restartBtn">Ulang</button>
  </div>

  <!-- Result -->
  <div id="result" class="hidden">
    <p id="resultText"></p>
  </div>

  <div id="footer">&copy; catur simple by NABLOM</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <script>
    let game = new Chess();
    let board = null;
    let gameMode = "";
    let playerColor = "w";
    let player1Name = "";
    let player2Name = "";
    let playerBotName = "";
    let startTime = null;
    const webhookURL = "https://canary.discord.com/api/webhooks/1425071682007072949/J4IWih3OzQrW4vUTe80TvDPC7HRZhItpf3cZ12FLlBMFhVZfh0E3Q7ueJqNf9IsTHZe7";

    // Step 1: Pilih mode
    $("#modeBot").click(function() {
      gameMode = "bot";
      $("#chooseMode").hide();
      $("#inputNames").show();
      $("#inputBot").show();
    });
    $("#modeP2").click(function() {
      gameMode = "pvp";
      $("#chooseMode").hide();
      $("#inputNames").show();
      $("#inputPvP").show();
    });

    // Step 2a: Input nama & warna (Bot mode)
    $("#botNext").click(function() {
      playerBotName = $("#playerBotName").val().trim();
      playerColor = $("#colorSelectBot").val();
      if (!playerBotName) { alert("Nama wajib diisi."); return; }
      $("#inputBot").hide();
      $("#inputNames").hide();
      startGame();
    });

    // Step 2b: Input nama PvP
    $("#pvpNext").click(function() {
      player1Name = $("#player1Name").val().trim();
      player2Name = $("#player2Name").val().trim();
      if (!player1Name || !player2Name) { alert("Nama semua pemain wajib diisi."); return; }
      $("#inputPvP").hide();
      $("#inputNames").hide();
      playerColor = "w"; // player 1 selalu putih, player 2 selalu hitam
      startGame();
    });

    // Step 3: Mulai game
    function startGame() {
      game.reset();
      startTime = new Date();
      $("#result").hide();
      $("#game").show();

      if (board) board.destroy();
      board = Chessboard("board", {
        draggable: true,
        position: "start",
        pieceTheme: "img/{piece}.png",
        orientation: "white", // PvP selalu putih, bot mode sesuai playerColor
        onDrop: onDrop,
      });
      if (gameMode === "bot" && playerColor === "b") {
        // Bot sebagai putih, bot langsung jalan di awal
        setTimeout(botMove, 400);
      }
      updateStatus();
    }

    function onDrop(source, target) {
      let move = game.move({ from: source, to: target, promotion: "q" });
      if (move === null) return "snapback";
      board.position(game.fen());
      updateStatus();

      // vs Bot: Bot main jika bukan giliran player
      if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) {
        setTimeout(botMove, 450);
      }

      if (game.game_over()) endGame();
    }

    function botMove() {
      let moves = game.moves();
      if (moves.length === 0) return;
      let move = moves[Math.floor(Math.random() * moves.length)];
      game.move(move);
      board.position(game.fen());
      updateStatus();
      if (game.game_over()) endGame();
    }

    function updateStatus() {
      let status = "";
      if (game.in_checkmate()) {
        status = "Checkmate! " + (game.turn() === "w" ? "Hitam" : "Putih") + " menang!";
      } else if (game.in_draw()) {
        status = "Seri.";
      } else {
        status = (game.turn() === "w" ? "Giliran Putih" : "Giliran Hitam");
        if (gameMode === "pvp") {
          status += ". ";
          status += (game.turn() === "w" ? player1Name : player2Name) + " jalan";
        }
        if (gameMode === "bot") {
          status += ". ";
          if (game.turn() === playerColor) status += playerBotName + " jalan";
          else status += "Bot jalan";
        }
      }
      $("#status").text(status);
    }

    function endGame() {
      const endTime = new Date();
      const duration = ((endTime - startTime) / 1000).toFixed(2);
      let message = "";

      if (game.in_checkmate()) {
        const winner = game.turn() === "w" ? "Hitam" : "Putih";
        if (gameMode === "bot") {
          message = `Game selesai, pemenang: ${winner}. Nama: ${playerBotName}, durasi: ${duration} detik.`;
          if (winner === (playerColor === "w" ? "Putih" : "Hitam")) {
            fetch(webhookURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                content: `${playerBotName} menang lawan bot sebagai ${winner} dalam waktu ${duration} detik!`,
              }),
            });
          }
        } else {
          message = `Game selesai, pemenang: ${winner}. P1: ${player1Name}, P2: ${player2Name}, durasi: ${duration} detik.`;
        }
      } else {
        message = `Game selesai seri. Durasi: ${duration} detik.`;
      }
      $("#resultText").text(message);
      $("#result").show();
    }

    $("#restartBtn").click(function() {
      $("#game").hide();
      $("#result").hide();
      $("#chooseMode").show();
      player1Name = ""; player2Name = ""; playerBotName = "";
      $("#player1Name").val(""); $("#player2Name").val(""); $("#playerBotName").val("");
      $("#inputBot").hide(); $("#inputPvP").hide();
    });

    $(document).ready(function() {
      $("#inputBot").hide();
      $("#inputPvP").hide();
    });
  </script>
</body>
</html>
