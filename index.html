<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Catur Web Unicode (Tata Foto Pemain Atas-Bawah)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; margin:0;}
    h2 { margin-bottom: 6px; margin-top:20px; }
    #chooseMode, #inputNames, #game, #result { margin-top: 15px;}
    #status { margin: 18px auto 10px auto; font-weight: bold; min-height: 32px; font-size: 1.2em;}
    #main-area { display: flex; flex-direction: column; align-items: center; }
    #player-atas, #player-bawah { display: flex; justify-content: center; align-items: center; gap: 14px; margin-bottom: 0; margin-top: 12px;}
    .player-img { width: 60px; height: 60px; object-fit: cover; border: 3px solid #222; border-radius: 8px; background: #fff;}
    .player-name { font-weight: bold; font-size: 1.15em; text-align: left;}
    #board-wrapper { display:inline-block; margin:0 auto; border:4px solid #888; border-radius:6px; background:#eee; }
    #board { display: grid; grid-template-columns: repeat(8, 44px); grid-template-rows: repeat(8, 44px); }
    .square { width: 44px; height: 44px; box-sizing: border-box; position: relative; cursor: pointer; }
    .square.dark { background: #c59a6c; }
    .square.light { background: #f2d1b3; }
    .square.selected { outline: 3px solid #2a7b1f; }
    .square.hint { border: 3px solid #2a7b1f; }
    .square.check { border: 3px solid #d40000; }
    .piece { width: 40px; height: 40px; line-height: 44px; font-size: 30px; user-select: none; pointer-events: none; }
    #restartBtn { margin: 18px 0 0 0; font-size: 1em; }
    .hidden { display: none;}
    #footer { margin-top: 40px; font-size: 12px; color: #777;}
    @media (max-width: 520px) {
      #board { grid-template-columns: repeat(8, 32px); grid-template-rows: repeat(8, 32px); }
      .square { width: 32px; height: 32px; }
      .piece { font-size: 21px; width:28px; height:28px;}
      #board-wrapper { border-width:2.5px; }
      .player-img { width: 40px; height: 40px; }
      #main-area { gap:12px; }
    }
  </style>
</head>
<body>
  <h2>Catur Web Unicode (Tata Foto Pemain Atas-Bawah)</h2>
  <!-- Pilih Mode -->
  <div id="chooseMode">
    <button id="modeBot">Player vs Bot</button>
    <button id="modeP2">Player vs Player</button>
  </div>
  <!-- Input Nama -->
  <div id="inputNames" class="hidden">
    <div id="inputBot" class="hidden">
      <input type="text" id="playerBotName" placeholder="Nama Anda"/>
      <label>Pilih warna:</label>
      <select id="colorSelectBot">
        <option value="w">Putih</option>
        <option value="b">Hitam</option>
      </select>
      <button id="botNext">Mulai</button>
    </div>
    <div id="inputPvP" class="hidden">
      <input type="text" id="player1Name" placeholder="Nama Pemain 1 (Putih)"/><br><br>
      <input type="text" id="player2Name" placeholder="Nama Pemain 2 (Hitam)"/><br><br>
      <button id="pvpNext">Mulai</button>
    </div>
  </div>
  <div id="game" class="hidden">
    <div id="status"></div>
    <div id="main-area">
      <div id="player-atas">
        <img class="player-img" id="imgAtas" src="img/hitam.png" alt="Hitam">
        <span class="player-name" id="namaAtas">Hitam</span>
      </div>
      <div id="board-wrapper"><div id="board"></div></div>
      <div id="player-bawah">
        <img class="player-img" id="imgBawah" src="img/putih.png" alt="Putih">
        <span class="player-name" id="namaBawah">Putih</span>
      </div>
    </div>
    <div id="result" class="hidden">
      <p id="resultText"></p>
    </div>
    <button id="restartBtn">Ulang Permainan</button>
  </div>
  <div id="footer">&copy; catur unicode NABLOM7</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script>
    const webhookURL = "https://canary.discord.com/api/webhooks/1425071682007072949/J4IWih3OzQrW4vUTe80TvDPC7HRZhItpf3cZ12FLlBMFhVZfh0E3Q7ueJqNf9IsTHZe7";
    const PIECE_UNICODE = {
      w: { k:'♔', q:'♕', r:'♖', b:'♗', n:'♘', p:'♙' },
      b: { k:'♚', q:'♛', r:'♜', b:'♝', n:'♞', p:'♟︎' }
    };
    const IMG_PUTIH = "img/putih.png";
    const IMG_HITAM = "img/hitam.png";
    const IMG_BOT   = "img/bot.png"; // opsional, bisa pakai hitam.png/putih.png juga

    let game = new Chess();
    let selected = null;
    let legalSquares = [];
    let gameMode = "";
    let playerColor = "w";
    let player1Name = "", player2Name = "", playerBotName = "";
    let startTime = null;
    let playerFoto = {}; // {atas:?, bawah:?}
    let playerNama = {}; // {atas:?, bawah:?}

    // Mode game
    document.getElementById("modeBot").onclick = function() {
      gameMode = "bot";
      document.getElementById("chooseMode").classList.add("hidden");
      document.getElementById("inputNames").classList.remove("hidden");
      document.getElementById("inputBot").classList.remove("hidden");
    };
    document.getElementById("modeP2").onclick = function() {
      gameMode = "pvp";
      document.getElementById("chooseMode").classList.add("hidden");
      document.getElementById("inputNames").classList.remove("hidden");
      document.getElementById("inputPvP").classList.remove("hidden");
    };
    document.getElementById("botNext").onclick = function() {
      playerBotName = document.getElementById("playerBotName").value.trim();
      playerColor = document.getElementById("colorSelectBot").value;
      if (!playerBotName) { alert("Nama wajib diisi."); return; }
      document.getElementById("inputBot").classList.add("hidden");
      document.getElementById("inputNames").classList.add("hidden");
      setFotoNama();
      startGame();
    };
    document.getElementById("pvpNext").onclick = function() {
      player1Name = document.getElementById("player1Name").value.trim();
      player2Name = document.getElementById("player2Name").value.trim();
      if (!player1Name || !player2Name) { alert("Nama semua pemain wajib diisi."); return; }
      document.getElementById("inputPvP").classList.add("hidden");
      document.getElementById("inputNames").classList.add("hidden");
      playerColor = "w";
      setFotoNama();
      startGame();
    };

    function setFotoNama() {
      // Tata letak: Pemain putih selalu di bawah, hitam di atas
      if (gameMode === "bot") {
        if (playerColor === "w") {
          // Pemain di bawah: putih.png + nama player
          playerFoto = { atas: IMG_HITAM, bawah: IMG_PUTIH };
          playerNama = { atas: "bot", bawah: playerBotName };
        } else {
          // Pemain di atas: hitam.png + nama player
          playerFoto = { atas: IMG_HITAM, bawah: IMG_PUTIH };
          playerNama = { atas: playerBotName, bawah: "bot" };
          // Tapi papan catur diorientasikan ke hitam, jadi pemain hitam di bawah
          // Untuk tetap konsisten, swap jika ingin hitam di bawah
          playerFoto = { atas: IMG_PUTIH, bawah: IMG_HITAM };
          playerNama = { atas: "bot", bawah: playerBotName };
        }
      } else {
        playerFoto = { atas: IMG_HITAM, bawah: IMG_PUTIH };
        playerNama = { atas: player2Name, bawah: player1Name };
      }
      document.getElementById("imgAtas").src = playerFoto.atas;
      document.getElementById("imgBawah").src = playerFoto.bawah;
      document.getElementById("namaAtas").textContent = playerNama.atas;
      document.getElementById("namaBawah").textContent = playerNama.bawah;
    }

    function startGame() {
      game.reset();
      selected = null; legalSquares = [];
      startTime = new Date();
      document.getElementById("result").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      setFotoNama();
      renderBoard();
      updateStatus();
      if (gameMode === "bot" && playerColor === "b") setTimeout(botMove, 500);
    }

    function renderBoard() {
      const boardEl = document.getElementById('board');
      boardEl.innerHTML = '';
      let fen = game.fen().split(' ')[0];
      let rows = fen.split('/');
      let checkSquare = getCheckSquare();
      for (let r = 0; r < 8; r++) {
        let row = rows[r];
        let file = 0;
        for (let idx = 0; idx < row.length && file < 8; idx++) {
          let ch = row[idx];
          if (ch >= '1' && ch <= '8') {
            for (let k = 0; k < Number(ch); k++) {
              let sqName = String.fromCharCode(97 + file) + (8 - r);
              let color = (r + file) % 2 ? 'dark' : 'light';
              let squareEmpty = document.createElement('div');
              squareEmpty.className = `square ${color}`;
              squareEmpty.setAttribute('data-square', sqName);
              if (legalSquares.includes(sqName)) squareEmpty.classList.add('hint');
              if (sqName === checkSquare) squareEmpty.classList.add('check');
              squareEmpty.onclick = () => squareClick(sqName);
              boardEl.appendChild(squareEmpty);
              file++;
            }
          } else {
            let sqName = String.fromCharCode(97 + file) + (8 - r);
            let color = (r + file) % 2 ? 'dark' : 'light';
            let square = document.createElement('div');
            square.className = `square ${color}`;
            square.setAttribute('data-square', sqName);
            if (selected === sqName) square.classList.add('selected');
            if (legalSquares.includes(sqName)) square.classList.add('hint');
            if (sqName === checkSquare) square.classList.add('check');
            let side = (ch === ch.toUpperCase()) ? 'w' : 'b';
            let type = ch.toLowerCase();
            let piece = document.createElement('div');
            piece.className = 'piece';
            piece.textContent = PIECE_UNICODE[side][type];
            square.appendChild(piece);
            square.onclick = () => squareClick(sqName);
            boardEl.appendChild(square);
            file++;
          }
        }
      }
    }

    function getCheckSquare() {
      if (!game.in_check()) return null;
      let turn = game.turn();
      let kingSquare = null;
      let boardArr = game.board();
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          let piece = boardArr[r][c];
          if (piece && piece.type === "k" && piece.color === turn) {
            kingSquare = String.fromCharCode(97 + c) + (8 - r);
            break;
          }
        }
      }
      return kingSquare;
    }

    function squareClick(square) {
      let piece = game.get(square);
      if (!selected) {
        if (piece && piece.color === game.turn()) {
          selected = square;
          legalSquares = game.moves({ square: square, verbose: true }).map(m => m.to);
        }
      }
      else if (legalSquares.includes(square)) {
        let moveObj = { from: selected, to: square };
        let isPromo = game.get(selected) && game.get(selected).type === 'p' &&
          ((game.get(selected).color === 'w' && selected[1] === '7' && square[1] === '8') ||
           (game.get(selected).color === 'b' && selected[1] === '2' && square[1] === '1'));
        if (isPromo) moveObj.promotion = prompt('Promosi ke (q,r,b,n):','q') || 'q';
        let move = game.move(moveObj);
        if (move) {
          selected = null; legalSquares = [];
          renderBoard();
          updateStatus();
          if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) setTimeout(botMove, 450);
          if (game.game_over()) endGame();
        }
      }
      else {
        selected = null; legalSquares = [];
      }
      renderBoard();
    }

    function botMove() {
      let moves = game.moves({ verbose: true });
      if (!moves.length) return;
      let promoMoves = moves.filter(m => m.flags.includes("p"));
      let move = promoMoves.length ? promoMoves.find(m => m.promotion === "q") || promoMoves[0] : moves[Math.floor(Math.random()*moves.length)];
      game.move({ from: move.from, to: move.to, promotion: move.promotion });
      selected = null; legalSquares = [];
      renderBoard();
      updateStatus();
      if (game.game_over()) endGame();
    }

    function updateStatus() {
      let status = '';
      if (game.in_check()) status = (game.turn() === 'w' ? "Raja Putih Skak! ":"Raja Hitam Skak! ");
      if (game.in_checkmate()) status += "Checkmate! " + (game.turn() === "w" ? "Hitam" : "Putih") + " menang!";
      else if (game.in_draw()) status += "Seri.";
      else {
        status += (game.turn() === "w" ? "Giliran Putih" : "Giliran Hitam");
        if (gameMode === "pvp") status += ". " + (game.turn() === "w" ? player1Name : player2Name) + " jalan";
        if (gameMode === "bot") status += ". " + (game.turn() === playerColor ? playerBotName : "Bot") + " jalan";
      }
      document.getElementById('status').textContent = status;
    }

    function endGame() {
      let status = document.getElementById("status").textContent;
      let endTime = new Date();
      let duration = ((endTime - startTime) / 1000).toFixed(2);
      let message = status + " (Durasi: " + duration + " detik)";
      document.getElementById("resultText").textContent = message;
      document.getElementById("result").classList.remove("hidden");

      // --- Kirim ke Discord Webhook ---
      let winner = "";
      if (game.in_checkmate()) {
        winner = game.turn() === "w" ? "Hitam" : "Putih";
        if (gameMode === "bot") {
          fetch(webhookURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              content: `[BOT] Permainan selesai! Pemenang: ${winner}. Nama: ${playerBotName}. Durasi: ${duration} detik.`
            })
          });
        } else {
          let pemenangNama = winner === "Putih" ? player1Name : player2Name;
          fetch(webhookURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              content: `[PvP] Permainan selesai! Pemenang: ${winner} (${pemenangNama}). Durasi: ${duration} detik.`
            })
          });
        }
      } else if (game.in_draw()) {
        fetch(webhookURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: `Permainan berakhir seri. Durasi: ${duration} detik.`
          })
        });
      }
    }

    document.getElementById('restartBtn').onclick = () => {
      document.getElementById("game").classList.add("hidden");
      document.getElementById("result").classList.add("hidden");
      document.getElementById("chooseMode").classList.remove("hidden");
      player1Name = ""; player2Name = ""; playerBotName = "";
      document.getElementById("player1Name").value = "";
      document.getElementById("player2Name").value = "";
      document.getElementById("playerBotName").value = "";
      document.getElementById("inputBot").classList.add("hidden");
      document.getElementById("inputPvP").classList.add("hidden");
    };

    // Hide input on load
    document.getElementById("inputBot").classList.add("hidden");
    document.getElementById("inputPvP").classList.add("hidden");
  </script>
</body>
</html>
