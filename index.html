<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Catur Web Custom Bidak</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 18px;}
    h2 { margin-bottom: 12px; }
    #welcome, #chooseMode, #inputNames, #game, #result { margin-top: 15px; }
    #board { margin: 12px auto; }
    button, input, select { font-size: 16px; padding: 8px 14px; border-radius: 5px; border: 1px solid #888; }
    button { cursor: pointer; background-color: #eaeaea; }
    button:hover { background-color: #cfcfcf; }
    input { width: 200px; }
    .hidden { display: none; }
    #status { margin-top: 12px; font-weight: bold; }
    #footer { margin-top: 40px; font-size: 12px; color: #777; }
    /* Modal promosi pawn */
    #promoModal.hidden { display:none; }
    #promoModal { position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;
      display:flex;align-items:center;justify-content:center;z-index:999; }
    #promoModal .modal-box { background:#fff;padding:22px 28px;border-radius:12px;
      box-shadow:0 4px 32px #0006;text-align:center; }
    #promoModal .promoBtn { font-size:17px;margin:7px 5px;border-radius:8px;padding:8px 22px; }
  </style>
</head>
<body>
  <h2>catur web</h2>
  <div id="welcome"><p>Selamat datang di catur web</p></div>

  <!-- Pilih Mode -->
  <div id="chooseMode">
    <button id="modeBot">Player vs Bot</button>
    <button id="modeP2">Player vs Player</button>
  </div>

  <!-- Input Nama -->
  <div id="inputNames" class="hidden">
    <div id="inputBot" class="hidden">
      <input type="text" id="playerBotName" placeholder="Nama Anda" />
      <label>Pilih warna:</label>
      <select id="colorSelectBot">
        <option value="w">Putih</option>
        <option value="b">Hitam</option>
      </select>
      <button id="botNext">Mulai</button>
    </div>
    <div id="inputPvP" class="hidden">
      <input type="text" id="player1Name" placeholder="Nama Pemain 1 (Putih)" /><br><br>
      <input type="text" id="player2Name" placeholder="Nama Pemain 2 (Hitam)" /><br><br>
      <button id="pvpNext">Mulai</button>
    </div>
  </div>

  <!-- Modal Promosi Bidak -->
  <div id="promoModal" class="hidden">
    <div class="modal-box">
      <h3>Pilih promosi bidak:</h3>
      <button class="promoBtn" data-piece="q">Ratu (Queen)</button>
      <button class="promoBtn" data-piece="r">Benteng (Rook)</button>
      <button class="promoBtn" data-piece="b">Gajah (Bishop)</button>
      <button class="promoBtn" data-piece="n">Kuda (Knight)</button>
    </div>
  </div>

  <!-- Game -->
  <div id="game" class="hidden">
    <div id="board" style="width: 320px;"></div>
    <div id="status"></div>
    <button id="restartBtn">Ulang</button>
  </div>

  <!-- Result -->
  <div id="result" class="hidden">
    <p id="resultText"></p>
  </div>

  <div id="footer">&copy; catur simple by NABLOM</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    let game = new Chess();
    let board = null;
    let gameMode = "";
    let playerColor = "w";
    let player1Name = "";
    let player2Name = "";
    let playerBotName = "";
    let startTime = null;
    const webhookURL = "https://canary.discord.com/api/webhooks/1425071682007072949/J4IWih3OzQrW4vUTe80TvDPC7HRZhItpf3cZ12FLlBMFhVZfh0E3Q7ueJqNf9IsTHZe7";
    let pendingPromotion = null; // Untuk promosi pawn

    // Step 1: Pilih mode
    $("#modeBot").click(function() {
      gameMode = "bot";
      $("#chooseMode").hide();
      $("#inputNames").show();
      $("#inputBot").show();
    });
    $("#modeP2").click(function() {
      gameMode = "pvp";
      $("#chooseMode").hide();
      $("#inputNames").show();
      $("#inputPvP").show();
    });

    // Step 2a: Input nama & warna (Bot mode)
    $("#botNext").click(function() {
      playerBotName = $("#playerBotName").val().trim();
      playerColor = $("#colorSelectBot").val();
      if (!playerBotName) { alert("Nama wajib diisi."); return; }
      $("#inputBot").hide();
      $("#inputNames").hide();
      startGame();
    });

    // Step 2b: Input nama PvP
    $("#pvpNext").click(function() {
      player1Name = $("#player1Name").val().trim();
      player2Name = $("#player2Name").val().trim();
      if (!player1Name || !player2Name) { alert("Nama semua pemain wajib diisi."); return; }
      $("#inputPvP").hide();
      $("#inputNames").hide();
      playerColor = "w"; // player 1 selalu putih, player 2 selalu hitam
      startGame();
    });

    // Step 3: Mulai game
    function startGame() {
      game.reset();
      startTime = new Date();
      $("#result").hide();
      $("#game").show();

      if (board) board.destroy();
      board = Chessboard("board", {
        draggable: true,
        position: "start",
        pieceTheme: "img/{piece}.png",
        orientation: (gameMode === "bot" ? (playerColor === "w" ? "white" : "black") : "white"),
        onDrop: onDrop,
      });
      if (gameMode === "bot" && playerColor === "b") {
        // Bot sebagai putih, bot langsung jalan di awal
        setTimeout(botMove, 400);
      }
      updateStatus();
    }

    function onDrop(source, target) {
      // cek apakah ini promosi pawn?
      let moveObj = { from: source, to: target };
      let move = null;
      let sourceRank = source[1];
      let targetRank = target[1];
      let pieceType = game.get(source) ? game.get(source).type : null;
      // Pawn di baris ke-7 (putih) atau ke-2 (hitam) menuju baris ke-8/1
      if (
        pieceType === 'p' &&
        ((game.turn() === 'w' && sourceRank === '7' && targetRank === '8') ||
         (game.turn() === 'b' && sourceRank === '2' && targetRank === '1'))
      ) {
        // Tampilkan modal promosi, tunggu input
        pendingPromotion = { from: source, to: target };
        $("#promoModal").removeClass("hidden");
        return "snapback"; // jangan diproses dulu
      } else {
        // Normal move
        moveObj.promotion = "q"; // default queen (biar tidak error di chess.js)
        move = game.move(moveObj);
      }

      if (move === null) return "snapback";
      board.position(game.fen());
      updateStatus();

      // vs Bot: Bot main jika bukan giliran player
      if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) {
        setTimeout(botMove, 450);
      }

      if (game.game_over()) endGame();
    }

    // Modal promosi handler
    $(".promoBtn").click(function(){
      let pieceType = $(this).data("piece");
      if(pendingPromotion) {
        let moveObj = {
          from: pendingPromotion.from,
          to: pendingPromotion.to,
          promotion: pieceType
        };
        let move = game.move(moveObj);
        if(move !== null){
          board.position(game.fen());
          updateStatus();
          $("#promoModal").addClass("hidden");
          pendingPromotion = null;

          // Bot jalan jika perlu
          if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) {
            setTimeout(botMove, 450);
          }
          if (game.game_over()) endGame();
        } else {
          alert("Promosi gagal!");
          $("#promoModal").addClass("hidden");
          pendingPromotion = null;
        }
      }
    });

    function botMove() {
      let moves = game.moves({ verbose: true });
      if (moves.length === 0) return;
      // Jika promosi, pilih queen
      let promoMoves = moves.filter(m => m.flags.includes("p"));
      let move;
      if (promoMoves.length > 0) {
        // Bot selalu pilih queen
        move = promoMoves.find(m => m.promotion === "q") || promoMoves[0];
        game.move({ from: move.from, to: move.to, promotion: move.promotion });
      } else {
        move = moves[Math.floor(Math.random() * moves.length)];
        game.move({ from: move.from, to: move.to, promotion: move.promotion });
      }
      board.position(game.fen());
      updateStatus();
      if (game.game_over()) endGame();
    }

    function updateStatus() {
      let status = "";
      if (game.in_checkmate()) {
        status = "Checkmate! " + (game.turn() === "w" ? "Hitam" : "Putih") + " menang!";
      } else if (game.in_draw()) {
        status = "Seri.";
      } else {
        status = (game.turn() === "w" ? "Giliran Putih" : "Giliran Hitam");
        if (gameMode === "pvp") {
          status += ". ";
          status += (game.turn() === "w" ? player1Name : player2Name) + " jalan";
        }
        if (gameMode === "bot") {
          status += ". ";
          if (game.turn() === playerColor) status += playerBotName + " jalan";
          else status += "Bot jalan";
        }
      }
      $("#status").text(status);
    }

    function endGame() {
      const endTime = new Date();
      const duration = ((endTime - startTime) / 1000).toFixed(2);
      let message = "";

      if (game.in_checkmate()) {
        const winner = game.turn() === "w" ? "Hitam" : "Putih";
        if (gameMode === "bot") {
          message = `Game selesai, pemenang: ${winner}. Nama: ${playerBotName}, durasi: ${duration} detik.`;
          if (winner === (playerColor === "w" ? "Putih" : "Hitam")) {
            fetch(webhookURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                content: `${playerBotName} menang lawan bot sebagai ${winner} dalam waktu ${duration} detik!`,
              }),
            });
          }
        } else {
          // PvP mode, kirim webhook ke discord
          let pemenangNama = (winner === "Putih") ? player1Name : player2Name;
          message = `Game selesai, pemenang: ${winner} (${pemenangNama}). P1: ${player1Name}, P2: ${player2Name}, durasi: ${duration} detik.`;
          fetch(webhookURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              content: `Permainan PvP selesai! Pemenang: ${winner} (${pemenangNama}). Durasi: ${duration} detik. Pemain Putih: ${player1Name}, Pemain Hitam: ${player2Name}`
            }),
          });
        }
      } else {
        message = `Game selesai seri. Durasi: ${duration} detik.`;
      }
      $("#resultText").text(message);
      $("#result").show();
    }

    $("#restartBtn").click(function() {
      $("#game").hide();
      $("#result").hide();
      $("#chooseMode").show();
      player1Name = ""; player2Name = ""; playerBotName = "";
      $("#player1Name").val(""); $("#player2Name").val(""); $("#playerBotName").val("");
      $("#inputBot").hide(); $("#inputPvP").hide();
    });

    $(document).ready(function() {
      $("#inputBot").hide();
      $("#inputPvP").hide();
    });
  </script>
</body>
</html>
