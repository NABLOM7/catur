<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Catur Web Custom Bidak</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 18px;}
    h2 { margin-bottom: 12px; }
    #welcome, #chooseMode, #chooseColor, #inputNames, #game, #result { margin-top: 15px; }
    #board { margin: 12px auto; }
    button, input, select { font-size: 16px; padding: 8px 14px; border-radius: 5px; border: 1px solid #888; }
    button { cursor: pointer; background-color: #eaeaea; }
    button:hover { background-color: #cfcfcf; }
    input { width: 200px; }
    .hidden { display: none; }
    #status { margin-top: 12px; font-weight: bold; }
    #footer { margin-top: 40px; font-size: 12px; color: #777; }
  </style>
</head>
<body>
  <h2>catur web</h2>
  <div id="welcome"><p>Selamat datang di catur web</p></div>

  <!-- Pilih Mode -->
  <div id="chooseMode">
    <button id="modeBot">Player vs Bot</button>
    <button id="modeP2">Player vs Player</button>
  </div>

  <!-- Input Nama -->
  <div id="inputNames" class="hidden">
    <div id="inputBot" class="hidden">
      <input type="text" id="playerBotName" placeholder="Nama Anda" />
      <button id="botNext">Lanjut</button>
    </div>
    <div id="inputP1" class="hidden">
      <input type="text" id="player1Name" placeholder="Nama Pemain 1" />
      <button id="p1Next">Lanjut</button>
    </div>
    <div id="inputP2" class="hidden">
      <input type="text" id="player2Name" placeholder="Nama Pemain 2" />
      <button id="p2Next">Lanjut</button>
    </div>
  </div>

  <!-- Pilih Warna -->
  <div id="chooseColor" class="hidden">
    <label>Pilih warna yang ingin dimainkan:</label><br>
    <select id="colorSelect">
      <option value="w">Putih</option>
      <option value="b">Hitam</option>
    </select>
    <button id="colorBtn">Mulai</button>
  </div>

  <!-- Game -->
  <div id="game" class="hidden">
    <div id="board" style="width: 320px;"></div>
    <div id="status"></div>
    <button id="restartBtn">Ulang</button>
  </div>

  <!-- Result -->
  <div id="result" class="hidden">
    <p id="resultText"></p>
  </div>

  <div id="footer">&copy; catur simple by NABLOM</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <script>
    // --- KONFIGURASI AWAL ---
    let game = new Chess();
    let board = null;
    let gameMode = "";
    let playerColor = "w";
    let player1Name = "";
    let player2Name = "";
    let playerBotName = "";
    let startTime = null;
    const webhookURL = "https://canary.discord.com/api/webhooks/1425071682007072949/J4IWih3OzQrW4vUTe80TvDPC7HRZhItpf3cZ12FLlBMFhVZfh0E3Q7ueJqNf9IsTHZe7";

    // --- LOGIKA TAMPILAN ---

    // Step 1: Pilih mode
    $("#modeBot").click(function() {
      gameMode = "bot";
      $("#chooseMode").hide();
      $("#inputNames").show();
      $("#inputBot").show();
    });
    $("#modeP2").click(function() {
      gameMode = "pvp";
      $("#chooseMode").hide();
      $("#inputNames").show();
      $("#inputP1").show();
    });

    // Step 2: Input nama
    $("#botNext").click(function() {
      playerBotName = $("#playerBotName").val().trim();
      if (!playerBotName) { alert("Nama wajib diisi."); return; }
      $("#inputBot").hide();
      $("#inputNames").hide();
      $("#chooseColor").show();
    });

    $("#p1Next").click(function() {
      player1Name = $("#player1Name").val().trim();
      if (!player1Name) { alert("Nama pemain 1 wajib diisi."); return; }
      $("#inputP1").hide();
      $("#inputP2").show();
    });

    $("#p2Next").click(function() {
      player2Name = $("#player2Name").val().trim();
      if (!player2Name) { alert("Nama pemain 2 wajib diisi."); return; }
      $("#inputP2").hide();
      $("#inputNames").hide();
      $("#chooseColor").show();
    });

    // Step 3: Pilih warna
    $("#colorBtn").click(function() {
      playerColor = $("#colorSelect").val();
      $("#chooseColor").hide();
      startGame();
    });

    // Step 4: Mulai game
    function startGame() {
      game.reset();
      startTime = new Date();
      $("#result").hide();
      $("#game").show();

      // Inisialisasi papan catur
      if (board) board.destroy();
      board = Chessboard("board", {
        draggable: true,
        position: "start",
        pieceTheme: "img/{piece}.png",
        orientation: playerColor === "w" ? "white" : "black",
        onDrop: onDrop,
      });

      updateStatus();
    }

    // --- LOGIKA GAME ---
    function onDrop(source, target) {
      let move = game.move({ from: source, to: target, promotion: "q" });
      if (move === null) return "snapback";
      board.position(game.fen());
      updateStatus();

      // vs Bot: Bot main jika bukan giliran player
      if (gameMode === "bot" && !game.game_over() && game.turn() !== playerColor) {
        setTimeout(botMove, 450);
      }

      if (game.game_over()) endGame();
    }

    function botMove() {
      let moves = game.moves();
      if (moves.length === 0) return;
      let move = moves[Math.floor(Math.random() * moves.length)];
      game.move(move);
      board.position(game.fen());
      updateStatus();
      if (game.game_over()) endGame();
    }

    function updateStatus() {
      let status = "";
      if (game.in_checkmate()) {
        status = "Checkmate! " + (game.turn() === "w" ? "Hitam" : "Putih") + " menang!";
      } else if (game.in_draw()) {
        status = "Seri.";
      } else {
        status = (game.turn() === "w" ? "Giliran Putih" : "Giliran Hitam");
        if (gameMode === "pvp") {
          status += ". ";
          status += (game.turn() === playerColor ? player1Name : player2Name) + " jalan";
        }
        if (gameMode === "bot") {
          status += ". ";
          if (game.turn() === playerColor) status += playerBotName + " jalan";
          else status += "Bot jalan";
        }
      }
      $("#status").text(status);
    }

    function endGame() {
      const endTime = new Date();
      const duration = ((endTime - startTime) / 1000).toFixed(2);
      let message = "";

      if (game.in_checkmate()) {
        const winner = game.turn() === "w" ? "Hitam" : "Putih";
        if (gameMode === "bot") {
          message = `Game selesai, pemenang: ${winner}. Nama: ${playerBotName}, durasi: ${duration} detik.`;
          // Discord
          if (winner === (playerColor === "w" ? "Putih" : "Hitam")) {
            fetch(webhookURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                content: `${playerBotName} menang lawan bot sebagai ${winner} dalam waktu ${duration} detik!`,
              }),
            });
          }
        } else {
          message = `Game selesai, pemenang: ${winner}. P1: ${player1Name}, P2: ${player2Name}, durasi: ${duration} detik.`;
        }
      } else {
        message = `Game selesai seri. Durasi: ${duration} detik.`;
      }

      $("#resultText").text(message);
      $("#result").show();
    }

    // Reset/ulang game
    $("#restartBtn").click(function() {
      $("#game").hide();
      $("#result").hide();
      $("#chooseMode").show();
      player1Name = ""; player2Name = ""; playerBotName = "";
      $("#player1Name").val(""); $("#player2Name").val(""); $("#playerBotName").val("");
      $("#inputBot").hide(); $("#inputP2").hide();
    });

    // Inisialisasi: hide semua input kecuali mode pilih
    $(document).ready(function() {
      $("#inputBot").hide();
      $("#inputP1").hide();
      $("#inputP2").hide();
      $("#chooseColor").hide();
    });
  </script>
</body>
</html>
